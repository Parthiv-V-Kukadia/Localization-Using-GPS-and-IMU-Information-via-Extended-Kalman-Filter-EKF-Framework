\begin{lstlisting}
% To obtain local NED from GPS, need to convert Geodetic to ECEF to NED coordinate frame.

% Convert Latitude and Longitude to Radians
lat_rad = deg2rad(lat);
lon_rad = deg2rad(lon);

% Create a function to convert GPS to NED coordinate Frame
function [NED_Coordinates] = GPStoNED(lat_rad, lon_rad, alt)
    % Constants for Earth Ellipsoid to convert from Geodetic to ECEF
    a = 6378137;
    b = 6356752.3142;
    e2 = 1 - (b^2 / a^2);
    % Define initial UAV position as reference position
    lat_0 = lat_rad(1); % Reference Latitude
    lon_0 = lon_rad(1); % Reference Longitude
    alt_0 = alt(1); % Reference Altitude
    % Convert defined intial GPS reference position to ECEF coordinate frame
    [x_e0, y_e0, z_e0] = GPStoECEF(lat_0, lon_0, alt_0, a, e2);
    % Create arrays for NED Coordinates to be stored after iteration
    NED_Coordinates = zeros(length(lat_rad), 3);
    % Loop over all GPS raw measurements and convert each to NED coordinates
    for i = 1:length(lat_rad)
        % Convert GPS raw measurements to ECEF coordinate frame
        [x_e, y_e, z_e] = GPStoECEF(lat_rad(i), lon_rad(i), alt(i), a, e2);
        % Convert ECEF measurements to NED coordinate frame
        [x_n, y_n, z_n] = ECEFtoNED(x_e, y_e, z_e, x_e0, y_e0, z_e0, lat_rad(i), lon_rad(I));
        % Store NED coordinates in created arrays
        NED_Coordinates(i, :) = [x_n, y_n, z_n];
    end
end

% Create a function to convert GPS to ECEF coordinate frame
function [x_e, y_e, z_e] = GPStoECEF(lat, lon, alt, a, e2)
    % Define radius of curvature
    N = a ./ sqrt(1 - e2 .* sin(lat).^2); % Radius of curvature
    % Convert GPS raw measurements to ECEF coordinate frame
    x_e = (N + alt) .* cos(lat) .* cos(lon);
    y_e = (N + alt) .* cos(lat) .* sin(lon);
    z_e = ((1 - e2) .* N + alt) .* sin(lat);
end

% Create a function to convert ECEF to NED coordinate frame
function [x_n, y_n, z_n] = ECEFtoNED(x_e, y_e, z_e, x_e0, y_e0, z_e0, lat, lon)
    % Difference between ECEF current coordinate and ECEF reference point
    dx = x_e - x_e0;
    dy = y_e - y_e0;
    dz = z_e - z_e0;
    % Rotation matrix to go from ECEF to NED coordinate system
    R = [-sin(lat) * cos(lon), -sin(lon) , -cos(lat) * cos(lon) ;
         -sin(lat) * sin(lon), cos(lon)  , -cos(lat) * sin(lon) ;
         cos(lat)            ,     0     , -sin(lat)           ];
    % Calculate NED coordinates
    NED = R' * [dx; dy; dz];
    x_n = NED(1); y_n = NED(2); z_n = NED(3);
end

% Run the NED_Coordinates function to compute a GPS to NED Coordinate
% Transform and substitute into correct naming convention [x_n, y_n, z_n]
[NED_coords] = GPStoNED(lat_rad, lon_rad, alt);
x_n = NED_coords(:,1); y_n = NED_coords(:,2); z_n = NED_coords(:,3);

%% GPS to NED Plot
figure; set(gcf,'numbertitle','off','name','NED Positions from GPS Raw Measurements');  
subplot(3,1,1); plot(t(125:end), x_n(125:end));title('NED Positions from GPS Raw Measurements'); ylabel('North (x_n, m)'); grid on;
subplot(3,1,2); plot(t(125:end), y_n(125:end)); ylabel('East (y_n, m)'); grid on;
subplot(3,1,3); plot(t(125:end), z_n(125:end)); ylabel('Down (z_n, m)'); grid on; xlabel('time (s)');
\end{lstlisting}
\captionof{figure}{MATLAB Code for GPS Raw Measurement to Local NED Positions}
\label{fig:GPS2NEDMatlab}
